
# The docs say you should do <maj>.<min>.<BUILD>, and you should,
# IF you are compiling with VS. But we are. I see the wisdom. Ah, well.

# This is a garbage version
version: '0.1.{build}'

# This resets the version programmatically
init:
 - ps: scripts\update-appveyor-version.ps1

branches:
  only:
    - master

#skip_non_tags: true

skip_commits:
  files:
    - 'docs/*'
    - '**/*.html'
    - '**/*.md'

max_jobs: 1

image: Visual Studios 2019

clone_folder: C:\projects\zic

shallow_clone: true

cache:
  - jar -> target/uberjar/*.jar
  - exe -> target/native-image/*.exe

install:
- cmd: >-
    if not exist build\bin\ (
      mkdir build
      mkdir build\bin
    )
    if not exist build\bin\bb.exe (
      del /s /f "%CD%\babashka-0.9.161-windows-amd64.zip"
      bitsadmin ^
          /transfer djhaskin987_bb ^
          /download ^
          /priority FOREGROUND ^
          "https://github.com/babashka/babashka/releases/download/v0.9.161/babashka-0.9.161-windows-amd64.zip" ^
          "%CD%\babashka-0.9.161-windows-amd64.zip"
      7z x babashka-0.9.161-windows-amd64.zip bb.exe
      mv bb.exe build\bin
    )
    if not exist build\bin\clj.exe (
      del /s /f "%CD%\deps.clj-0.1.1155-2-windows-amd64.zip"
      bitsadmin ^
          /transfer djhaskin987_deps ^
          /download ^
          /priority FOREGROUND ^
          "https://github.com/borkdude/deps.clj/releases/download/v0.1.1155-2/deps.clj-0.1.1155-2-windows-amd64.zip" ^
          "%CD%\deps.clj-0.1.1155-2-windows-amd64.zip"
      7z x deps.clj-0.1.1155-2-windows-amd64.zip deps.exe
      move deps.exe build\bin\clj.exe
    )
    if not exist build\graalvm-ce-java11-windows-amd64-21.3.0 (
      del /s /f "%CD%\graalvm-ce-java11-windows-amd64-21.3.0.zip"
      bitsadmin ^
          /transfer djhaskin987_graalvm ^
          /download ^
          /priority FOREGROUND ^
          "https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-21.3.0/graalvm-ce-java11-windows-amd64-21.3.0.zip"
          "%CD%\graalvm-ce-java11-windows-amd64-21.3.0.zip"
      7z x graalvm-ce-java11-windows-amd64-21.3.0.zip
      move graalvm-ce-java11-windows-amd64-21.3.0 build\graalvm-ce-java-11-amd64-21.3.0
    )

build_script:
- cmd: >-
    set "PATH=%cd%\build\bin;%PATH%"
    set "JAVA_HOME=%cd%\build\graalvm-ce-java-11-amd64-21.3.0"
    call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
    clj -T:build uber

    call script\compile.bat
    7z a dtlv-%APPVEYOR_REPO_TAG_NAME%-windows-amd64.zip dtlv.exe